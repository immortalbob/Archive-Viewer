<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ACCPP Archive File Tree</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body class="dark-mode">
    <h1>ACCPP Archive File Tree</h1>
    <div class="header-buttons">
        <button id="open-archive" onclick="openArchive()">Open Archive</button>
        <button id="dark-mode-toggle" onclick="toggleDarkMode()">Toggle Dark Mode</button>
    </div>
    <div class="container">
        <div id="directory-tree">Loading...</div>
        <div id="file-details">Select a directory to view its files</div>
    </div>
    
    <script>
        function removeDriveLetter(path) {
            return path.replace(/^D:\\ACCPP\\/, '');
        }

        function createTree(data, path = '') {
            const ul = document.createElement('ul');
            for (const key in data) {
                const li = document.createElement('li');
                const span = document.createElement('span');
                span.textContent = `+ ${key}`;
                if (typeof data[key] === 'object' && !data[key].hasOwnProperty('FullName')) {
                    li.className = 'directory collapsed';
                    span.onclick = () => {
                        li.classList.toggle('collapsed');
                        const isCollapsed = li.classList.contains('collapsed');
                        span.textContent = `${isCollapsed ? '+' : '-'} ${key}`;
                        highlightPath(`${path}/${key}`);
                        displayFiles(data[key], `${path}/${key}`);
                    };
                    li.appendChild(span);
                    const childrenUl = createTree(data[key], `${path}/${key}`);
                    if (childrenUl) {
                        li.appendChild(childrenUl);
                    }
                }
                ul.appendChild(li);
            }
            return ul;
        }

        function displayFiles(data, path) {
            const fileDetails = document.getElementById('file-details');
            const cleanPath = removeDriveLetter(path).replace(/\\/g, '/');

            fileDetails.innerHTML = `<h2>Files in ${cleanPath}</h2>`;
            
            for (const key in data) {
                if (typeof data[key] === 'object' && data[key].hasOwnProperty('FullName')) {
                    const details = document.createElement('div');
                    details.className = 'details';

                    const fields = {
                        'Name': 'FileName',
                        'FullName': 'FilePath',
                        'Extension': 'Extension',
                        'Length': 'Size',
                        'CreationTime': 'CreationTime',
                        'LastWriteTime': 'LastWriteTime',
                        'Hash': 'Hash'
                    };

                    const order = ['FileName', 'FilePath', 'Extension', 'Size', 'CreationTime', 'LastWriteTime', 'Hash'];

                    const table = document.createElement('table');
                    const tbody = document.createElement('tbody');

                    order.forEach(field => {
                        for (const prop in fields) {
                            if (fields[prop] === field && data[key].hasOwnProperty(prop)) {
                                const tr = document.createElement('tr');
                                const tdField = document.createElement('td');
                                tdField.textContent = `${field}:`;
                                const tdValue = document.createElement('td');
                                tdValue.textContent = data[key][prop];
                                tr.appendChild(tdField);
                                tr.appendChild(tdValue);
                                tbody.appendChild(tr);
                            }
                        }
                    });

                    table.appendChild(tbody);
                    details.appendChild(table);
                    fileDetails.appendChild(details);
                }
            }
            fileDetails.scrollTop = 0; // Reset scroll position to the top
        }

        function highlightPath(path) {
            const spans = document.querySelectorAll('#directory-tree span');
            spans.forEach(span => {
                span.classList.remove('selected');
            });

            const parts = path.split('/');
            let currentPath = '';
            parts.forEach(part => {
                currentPath += currentPath === '' ? part : `/${part}`;
                const span = Array.from(document.querySelectorAll('#directory-tree span'))
                    .find(span => span.textContent.includes(part) && span.onclick.toString().includes(currentPath));
                if (span) {
                    span.classList.add('selected');
                }
            });
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            if (document.body.classList.contains('dark-mode')) {
                document.body.classList.remove('light-mode');
            } else {
                document.body.classList.add('light-mode');
            }
        }

        function openArchive() {
            window.open("https://mega.nz/folder/L1MniCKJ#1dQCCFPc2ddcFILa_JGeZw", "_blank");
        }

        // Automatically enable dark mode on load
        window.onload = () => {
            document.body.classList.add('dark-mode');
        }

        fetch('/api/directory_tree')
            .then(response => response.json())
            .then(data => {
                console.log('Fetched data:', data);
                const tree = createTree(data);
                document.getElementById('directory-tree').innerHTML = '';
                document.getElementById('directory-tree').appendChild(tree);
            })
            .catch(error => {
                console.error('Error fetching directory tree:', error);
                document.getElementById('directory-tree').innerHTML = 'Error loading directory tree';
            });
    </script>
</body>
</html>
